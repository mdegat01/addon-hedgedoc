include <tunables/global>

# Docker overlay
@{docker_root}=/docker/ /var/lib/docker/
@{fs_root}=/ @{docker_root}/overlay2/*/diff/
@{do_etc}=@{fs_root}/etc/
@{do_opt}=@{fs_root}/opt/
@{do_run}=@{fs_root}/{run,var/run}/
@{do_usr}=@{fs_root}/usr/
@{do_var}=@{fs_root}/var/

profile hedgedoc flags=(attach_disconnected,mediate_deleted) {
  include <abstractions/base>
  include <abstractions/bash>

  # Send signals to child services
  signal (send) peer=@{profile_name}//*,

  # Capabilities to run service as non-root
  capability kill,
  capability dac_override,
  capability chown,
  capability fowner,
  capability fsetid,
  capability setuid,
  capability setgid,

  # Network access
  network tcp,
  network udp,

  # S6-Overlay
  /init                                           rix,
  /bin/**                                         rix,
  /usr/bin/**                                     rix,
  @{do_etc}/s6/**                                 r,
  @{do_etc}/cont-{init,finish}.d/{,**}            r,
  @{do_etc}/fix-attrs.d/{,**}                     r,
  @{do_etc}/{s6-rc,services}.d/{,**}              r,
  @{do_run}/{s6,s6-rc*,service}/**                rix,
  /command/**                                     rix,
  /package/**                                     rix,
  @{do_run}/{,**}                                 rwk,
  /dev/tty                                        rw,
  @{do_usr}/lib/locale/{,**}                      r,
  @{do_etc}/ssl{,1.1}/openssl.cnf                 r,
  @{do_etc}/{group,hosts,passwd,resolv.conf}      r,
  /dev/null                                       k,

  # Bashio
  /usr/lib/bashio/**                              ix,
  /tmp/**                                         rw,

  # MariaDB
  @{do_etc}/{services,my.cnf}                     r,
  @{do_etc}/my.cnf.d/{,**}                        r,
  @{do_usr}/share/mariadb/**                      r,
  /usr/bin/mysql                                  Cx,

  # Options.json & addon data
  /data                                           r,
  /data/**                                        rw,

  # Files needed for setup
  @{do_etc}/hedgedoc/{,**}                        rw,
  @{do_opt}/hedgedoc/{.sequelizerc,config.json}   w,
  @{do_opt}/hedgedoc/public/**                    w,
  @{do_opt}/hedgedoc/{,**}                        r,
  /ssl/{,**}                                      r,
  link /opt/hedgedoc/config.json -> /etc/hedgedoc/config.json,
  link /opt/hedgedoc/public/** -> /data/hedgedoc/**,

  # Programs
  /usr/bin/openssl                                Cx,
  /usr/bin/node                                   cx -> node,
  /opt/hedgedoc/node_modules/sequelize-cli/lib/sequelize  Cx -> node,

  profile node flags=(attach_disconnected,mediate_deleted) {
    include <abstractions/base>

    # Receive signals from s6
    signal (receive) peer=*_hedgedoc,

    # Network access
    network tcp,
    network udp,

    # Addon data
    /data/**                                        r,
    /data/hedgedoc/**                               rwk,

    # Config
    @{do_etc}/hedgedoc/config.json                  r,
    @{do_opt}/hedgedoc/**                           r,
    /ssl/**                                         r,

    # Executables
    /bin/busybox                                    rmix,
    /opt/hedgedoc/bin/**                            rix,
    /usr/bin/node                                   rix,

    # Runtime usage
    owner /tmp/**                                   rw,
    @{do_etc}/{hosts,resolv.conf}                   r,
    @{do_etc}/ssl{,1.1}/openssl.cnf                 r,
    @{do_usr}/share/ca-certificates/**              r,
    @{PROC}/[1-9]*/{limits,stat}                    r,
    @{PROC}/loadavg                                 r,
    @{sys}/fs/cgroup/memory/memory.limit_in_bytes   r,
    /opt/hedgedoc/node_modules/*/prebuilds/**.node  rm,
  }

  profile /usr/bin/openssl flags=(attach_disconnected,mediate_deleted) {
    include <abstractions/base>

    /data/dhparams.pem                              w,
    /usr/bin/openssl                                rm,
    @{do_etc}/ssl/openssl.cnf                       r,
  }

  profile /usr/bin/mysql flags=(attach_disconnected,mediate_deleted) {
    include <abstractions/base>
    include <abstractions/mysql>
  }
}
